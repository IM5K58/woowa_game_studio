<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${title}"></title>
    <style>
        body { background-color: #f0f0f0; font-family: sans-serif; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }

        /* íŠ¸ë™ ìŠ¤íƒ€ì¼ */
        .track-container { margin-top: 20px; max-height: 500px; overflow-y: auto; border: 2px solid #333; padding: 10px; background: #444; }
        .lane { display: flex; align-items: center; margin-bottom: 5px; height: 30px; border-bottom: 1px dashed #777; position: relative; }
        .car-name { width: 60px; color: white; font-weight: bold; font-size: 0.8rem; text-align: right; margin-right: 10px; }
        .track { flex-grow: 1; position: relative; height: 100%; background: #555; border-radius: 0 5px 5px 0; }
        .car {
            width: 30px; height: 24px; background-color: #f1c40f; border-radius: 3px;
            position: absolute; left: 0; top: 3px; transition: left 0.5s linear; /* ì›€ì§ì„ íš¨ê³¼ */
            display: flex; justify-content: center; align-items: center; font-size: 0.7rem; color: black;
        }
        .finish-line { position: absolute; right: 10px; top: 0; bottom: 0; width: 5px; background: repeating-linear-gradient(white, white 5px, black 5px, black 10px); }

        /* ë‚´ ì°¨ ê°•ì¡° */
        .my-car { background-color: #e74c3c !important; color: white !important; z-index: 10; box-shadow: 0 0 5px white; }

        .controls { margin-top: 20px; padding: 20px; background: #eee; border-radius: 10px; text-align: center; }
        input, select, button { padding: 10px; font-size: 1.1rem; margin: 5px; }
        .result-msg { font-size: 1.5rem; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1 th:text="${title}"></h1>
    <h3>í˜„ì¬ ì†Œì§€ê¸ˆ: <span th:text="${#numbers.formatInteger(user.money, 0, 'COMMA')}"></span>ì›</h3>

    <div class="controls" th:if="${result == null}">
        <form action="/game/race/play" method="POST">
            <input type="hidden" name="multiplier" th:value="${multiplier}">
            <input type="hidden" name="carCount" th:value="${carCount}">

            <label>ë°°íŒ… ê¸ˆì•¡:</label>
            <input type="number" name="betAmount" min="5000" placeholder="ìµœì†Œ 5000ì›" required>

            <label>ìš°ìŠ¹ ì˜ˆìƒ ì°¨ëŸ‰:</label>
            <select name="selectedCar">
                <option th:each="car : ${carList}" th:value="${car}" th:text="${car}"></option>
            </select>

            <button type="submit" style="background-color: #27ae60; color: white; cursor: pointer;">ğŸ ê²½ê¸° ì‹œì‘</button>
        </form>
        <p style="color: red;" th:if="${error}" th:text="${error}"></p>
    </div>

    <div id="final-result" class="controls" style="display: none;">
        <div id="result-text" class="result-msg"></div>
        <a th:href="@{/game/race/{m}(m=${multiplier == 1000 ? '???' : multiplier})}" class="button">ë‹¤ì‹œí•˜ê¸°</a>
        <a href="/game/race" class="button">ë‹¤ë¥¸ ë°°ìœ¨ ê³ ë¥´ê¸°</a>
    </div>

    <div class="track-container">
        <div class="lane" th:each="car : ${carList}">
            <div class="car-name" th:text="${car}"></div>
            <div class="track">
                <div class="finish-line"></div>
                <div class="car" th:id="'car-' + ${car}" th:text="ğŸï¸"></div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /* ì„œë²„ì—ì„œ ë°›ì€ ê²°ê³¼ ë°ì´í„° (ì—†ìœ¼ë©´ null) */
    const result = [[${result}]];
    const myCarName = [[${result?.userCarName}]]; // ë‚´ê°€ ì„ íƒí•œ ì°¨ ì´ë¦„

    if (result != null) {
        // ë‚´ ì°¨ í‘œì‹œ (ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½)
        const myCarElement = document.getElementById('car-' + myCarName);
        if (myCarElement) myCarElement.classList.add('my-car');

        startAnimation(result.history, result.winners, result.isUserWin, result.reward);
    }

    function startAnimation(history, winners, isUserWin, reward) {
        let roundIndex = 0;
        const totalRounds = history.length;
        const trackWidth = document.querySelector('.track').offsetWidth - 50; // ì‹¤ì œ ì´ë™ ê°€ëŠ¥ ê±°ë¦¬ (ì—¬ë°± ì œì™¸)
        const stepSize = trackWidth / 10; // 10ì¹¸ ê¸°ì¤€ 1ì¹¸ í¬ê¸°

        // 0.5ì´ˆë§ˆë‹¤ í•œ ë¼ìš´ë“œì”© ì§„í–‰
        const timer = setInterval(() => {
            if (roundIndex >= totalRounds) {
                clearInterval(timer);
                showResult(winners, isUserWin, reward);
                return;
            }

            const roundData = history[roundIndex]; // ì´ë²ˆ ë¼ìš´ë“œì˜ ëª¨ë“  ì°¨ ìœ„ì¹˜ ì •ë³´

            // ëª¨ë“  ì°¨ì˜ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            for (const [carName, position] of Object.entries(roundData)) {
                const carEl = document.getElementById('car-' + carName);
                if (carEl) {
                    // position(0~10) * stepSize ë§Œí¼ ì™¼ìª½ ì—¬ë°±(left)ì„ ì¤Œ
                    carEl.style.left = (position * stepSize) + 'px';
                }
            }
            roundIndex++;
        }, 500); // 500ms = 0.5ì´ˆ
    }

    function showResult(winners, isUserWin, reward) {
        const resultDiv = document.getElementById('final-result');
        const textDiv = document.getElementById('result-text');

        resultDiv.style.display = 'block';

        let msg = "ğŸ† ìš°ìŠ¹: " + winners.join(", ") + "<br>";
        if (isUserWin) {
            msg += "<span style='color:blue'>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! " + reward.toLocaleString() + "ì›ì„ íšë“í–ˆìŠµë‹ˆë‹¤!</span>";
        } else {
            msg += "<span style='color:red'>ğŸ˜­ ì•„ì‰½ê²Œë„ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...</span>";
        }
        textDiv.innerHTML = msg;
    }
</script>

</body>
</html>